#!/usr/bin/env bash
set -euo pipefail

# Enforce Conventional Commits via Commitizen (cz).
# Git passes the commit message file path as $1.
#
# IMPORTANT:
# This file must contain ONLY hook logic.
# Installer/setup commands (cat >..., chmod +x..., mkdir -p...) belong in scripts/,
# not in this hook.

# Guard against accidentally committing installer commands into the hook.
# Ignore comment lines; only fail on actual command lines.
if grep -vE '^[[:space:]]*#' "$0" | grep -qE '^[[:space:]]*(mkdir -p[[:space:]]+\.githooks|cat[[:space:]]+>[[:space:]]+\.githooks/commit-msg|chmod[[:space:]]+\+x[[:space:]]+\.githooks/commit-msg)'; then
  echo "commit-msg: hook file contains installer commands; it must contain only hook logic." >&2
  exit 1
fi

if [[ -z "${1:-}" ]]; then
  echo "commit-msg: missing commit message file argument" >&2
  exit 1
fi

# One-off bypass (use sparingly)
if [[ "${SKIP_COMMIT_MSG_CHECK:-}" == "1" ]]; then
  echo "commit-msg: SKIP_COMMIT_MSG_CHECK=1 set; skipping commit message validation."
  exit 0
fi

if ! command -v cz >/dev/null 2>&1; then
  echo "commit-msg: 'cz' not found. Install Commitizen or run commits via 'cz commit'." >&2
  echo "  Tip: pipx install commitizen" >&2
  exit 1
fi

# Validate the commit message file.
cz check --commit-msg-file "$1"
